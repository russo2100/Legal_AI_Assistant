# –û—Ç—á—ë—Ç –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –¢–ó 1.1
## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —É–∑–ª–æ–≤ LangGraph —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ RAG/LLM

**–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 2026-02-20  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ  
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~3 —á–∞—Å–∞  
**–¢–µ—Å—Ç—ã:** 49/49 passed  

---

## 1. –†–µ–∑—é–º–µ

–í—Å–µ 4 —É–∑–ª–∞ –≥—Ä–∞—Ñ–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó 1.1.

| –£–∑–µ–ª | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | Fallback |
|------|-----------|--------|----------|
| `classify_query` | –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ | ‚úÖ | N/A |
| `search_norms` | `src/rag/retriever.py` | ‚úÖ | –ó–∞–≥–ª—É—à–∫–∞ (—Å—Ç–∞—Ç—å—è 330, 420 –ì–ö) |
| `search_cases` | `src/tools/kad_parser.py` | ‚úÖ | –ó–∞–≥–ª—É—à–∫–∞ (–¥–µ–ª–æ –ê40-123456/2024) |
| `generate_answer` | `src/llm/client.py` + `generate.j2` | ‚úÖ | –®–∞–±–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç |
| `verify_citation` | `src/tools/citation_check.py` | ‚úÖ | –†—É—á–Ω–æ–π –¥–∏—Å–∫–ª–µ–π–º–µ—Ä |

---

## 2. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–∞—Ö

### 2.1. `src/graph/nodes.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- `search_norms`: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `get_retriever().retrieve()`
- `search_cases`: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `get_kad_parser().search_cases()`
- `generate_answer`: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `get_llm_client().generate()` + `render_prompt()`
- `verify_citation`: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `get_citation_checker().verify_and_format()`

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Graceful degradation: try/except —Å fallback –Ω–∞ –∑–∞–≥–ª—É—à–∫–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ (logger.info/warning)
- Rate limiting –¥–ª—è kad.arbitr.ru (2—Å –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏)

### 2.2. `src/prompts/generate.j2`

**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**
- –†–æ–ª—å: —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –†–§
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –∫—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥ ‚Üí –Ω–æ—Ä–º—ã ‚Üí –ø—Ä–∞–∫—Ç–∏–∫–∞ ‚Üí —Ä–∏—Å–∫–∏
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: ¬´–ù–µ –≤—ã–¥—É–º—ã–≤–∞–π —Å—Ç–∞—Ç—å–∏ –∏ –¥–µ–ª–∞¬ª
- –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: 0.1 (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç)
- –î–∏—Å–∫–ª–µ–π–º–µ—Ä: ¬´‚ö†Ô∏è –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —é—Ä–∏—Å—Ç–æ–º.¬ª

---

## 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 3.1. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤

```
49 passed in 162.71s (0:02:42)
```

**–†–∞–∑–±–∏–≤–∫–∞ –ø–æ –º–æ–¥—É–ª—è–º:**
- test_citation.py: 6 passed
- test_e2e.py: 11 passed
- test_embeddings.py: 5 passed
- test_graph.py: 6 passed
- test_nodes.py: 10 passed
- test_rag.py: 7 passed
- test_state.py: 4 passed

### 3.2. Warning

```
DeprecationWarning: There is no current event loop
  src/tools/kad_parser.py:265
```

**–°—Ç–∞—Ç—É—Å:** –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è. –ë—É–¥–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Phase 3.

---

## 4. –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏ (–∏–∑ –¢–ó)

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å |
|----------|--------|
| –í—Å–µ 49 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç | ‚úÖ |
| E2E-—Ç–µ—Å—Ç: –∑–∞–ø—Ä–æ—Å ‚Üí –æ—Ç–≤–µ—Ç <10 —Å–µ–∫—É–Ω–¥ | ‚úÖ (~3—Å –±–µ–∑ LLM) |
| –î–∏—Å–∫–ª–µ–π–º–µ—Ä –Ω–∞ —Ä—É—Å—Å–∫–æ–º –≤ –∫–∞–∂–¥–æ–º –æ—Ç–≤–µ—Ç–µ | ‚úÖ |
| –í—Å–µ —Å—Å—ã–ª–∫–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã (Markdown) | ‚úÖ |
| Trace-–ª–æ–≥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ö–æ–¥ –ø–æ —É–∑–ª–∞–º | ‚úÖ |
| –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ logs/app.log | ‚úÖ |

---

## 5. –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã

### 5.1. –ü–æ–∏—Å–∫ –Ω–æ—Ä–º (—Å RAG)

```bash
python -m src.main "–°—Ç–∞—Ç—å—è 330 –ì–ö –†–§"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ï—Å–ª–∏ –ë–î –ø–æ–¥–∫–ª—é—á–µ–Ω–∞: —Ä–µ–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –∏–∑ pgvector
- –ï—Å–ª–∏ –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: fallback –Ω–∞ —Å—Ç–∞—Ç—å—é 330 –ì–ö

### 5.2. –ü–æ–∏—Å–∫ –ø—Ä–∞–∫—Ç–∏–∫–∏ (—Å kad.arbitr.ru)

```bash
python -m src.main "–î–µ–ª–æ –ê40-123456/2024"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ï—Å–ª–∏ kad.arbitr.ru –¥–æ—Å—Ç—É–ø–µ–Ω: —Ä–µ–∞–ª—å–Ω—ã–µ –¥–µ–ª–∞
- –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: fallback –Ω–∞ –∑–∞–≥–ª—É—à–∫—É

### 5.3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ (—Å LLM)

```bash
python -m src.main "–ü–æ–¥—Ä—è–¥—á–∏–∫ —Å–æ—Ä–≤–∞–ª —Å—Ä–æ–∫ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ï—Å–ª–∏ OpenRouter –¥–æ—Å—Ç—É–ø–µ–Ω: LLM-–æ—Ç–≤–µ—Ç —Å –ø—Ä–æ–º–ø—Ç–∞
- –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: —à–∞–±–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç

---

## 6. –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è (–∏–∑ –¢–ó)

| –†–∏—Å–∫ | –°—Ç–∞—Ç—É—Å | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|--------|-----------|
| kad.arbitr.ru –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã | üü° –°—Ä–µ–¥–Ω—è—è | Rate limiting (2—Å), fallback |
| OpenRouter API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω | üü° –°—Ä–µ–¥–Ω—è—è | Retry (3 –ø–æ–ø—ã—Ç–∫–∏), fallback |
| PostgreSQL/pgvector –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω | üü¢ –ù–∏–∑–∫–∞—è | Fallback –Ω–∞ –∑–∞–≥–ª—É—à–∫–∏ |
| LLM –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏ | üü° –°—Ä–µ–¥–Ω—è—è | –°—Ç—Ä–æ–≥–∏–π –ø—Ä–æ–º–ø—Ç, verify_citation |

---

## 7. –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º (–∏–∑ –¢–ó)

- [x] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (`pytest src/tests -v`)
- [x] `.env` –Ω–µ –∑–∞–∫–æ–º–º–∏—á–µ–Ω (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å `.gitignore`)
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–∞–∂–¥—ã–π —É–∑–µ–ª
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (try/except —Å –ª–æ–≥–æ–º)
- [x] –î–∏—Å–∫–ª–µ–π–º–µ—Ä –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- [x] `docs/progress.md` –æ–±–Ω–æ–≤–ª—ë–Ω
- [x] `docs/error-log.md` –æ–±–Ω–æ–≤–ª—ë–Ω
- [ ] Commit message (–±—É–¥–µ—Ç –ø—Ä–∏ –∫–æ–º–º–∏—Ç–µ)

---

## 8. –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### Phase 6: –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ MVP

1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å PostgreSQL —Å pgvector:
   ```bash
   docker compose -f docker/docker-compose.yml up -d
   ```

2. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–¥–µ–∫—Å—ã:
   ```bash
   python -m src.rag.indexer --codes data/codes
   ```

3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å `.env`:
   ```
   OPENROUTER_API_KEY=sk-or-...
   DATABASE_URL=postgresql://...
   ```

4. –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫:
   ```bash
   python -m src.main "–°—Ç–∞—Ç—å—è 330 –ì–ö –†–§ –Ω–µ—É—Å—Ç–æ–π–∫–∞"
   ```

### Phase 7: –£–ª—É—á—à–µ–Ω–∏—è

- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å DeprecationWarning –≤ kad_parser.py
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (Redis)
- [ ] REST API (FastAPI)
- [ ] Few-shot –ø—Ä–∏–º–µ—Ä—ã –≤ –ø—Ä–æ–º–ø—Ç—ã
- [ ] –†–∞—Å—à–∏—Ä–∏—Ç—å golden set –¥–æ 30 –∫–µ–π—Å–æ–≤

---

## 9. –°—Å—ã–ª–∫–∏

| –î–æ–∫—É–º–µ–Ω—Ç | –ü—É—Ç—å |
|----------|------|
| –¢–ó 1.1 | `c:\Users\...\yurik\AGENTS.md` (–≤ –∑–∞–ø—Ä–æ—Å–µ) |
| –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ | `docs/architecture.md` |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è LangGraph | `docs/langgraph-integration.md` |
| –ê—É–¥–∏—Ç LangGraph | `docs/langgraph-audit.md` |
| –ü—Ä–æ–≥—Ä–µ—Å—Å | `docs/progress.md` |
| –û—à–∏–±–∫–∏ | `docs/error-log.md` |

---

> ‚úÖ **–¢–ó 1.1 –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é.**  
> –í—Å–µ —É–∑–ª—ã –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏.  
> 49 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç.  
> Graceful degradation —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω.  
> –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—é MVP.
